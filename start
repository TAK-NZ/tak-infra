#!/bin/bash
#
# Build CoreConfig & Associated Cert Generation
#

. $NVM_DIR/nvm.sh

set -x
set -euo pipefail

# Copy EFS Persisted certs to Let's Encrypt Dir
if [ -d "/ops/tak/certs/${HostedDomain}" ]; then
    mkdir -o "/etc/letsencrypt/live/${HostedDomain}"
    cp "/ops/tak/certs/${HostedDomain}/*" "/etc/letsencrypt/live/${HostedDomain}"
fi;

# If no LetsEncrypt certs are present - generate a set
if [ ! -d "/etc/letsencrypt/live/${HostedDomain}" ]; then
    echo "No Certificates detected - $(ls /etc/letsencrypt/live/)"

    #TODO Remove Test Cert
    Command="certbot certonly -v --test-cert --standalone -d ${HostedDomain} --email ${HostedEmail} --non-interactive --agree-tos"

    while ! $Command; do
        echo "Command failed, retrying in 10 seconds..."
        sleep 10
    done

    /opt/tak/certs/cert-metadata.sh

    mkdir -p "/ops/tak/certs/${HostedDomain}/"

    openssl x509 \
        -text \
        -in "/etc/letsencrypt/live/${HostedDomain}/fullchain.pem" \
         -noout

    openssl pkcs12 \
        -export \
        -in "/etc/letsencrypt/live/${HostedDomain}/fullchain.pem" \
        -inkey "/etc/letsencrypt/live/${HostedDomain}/privkey.pem" \
        -out "/ops/tak/certs/${HostedDomain}/takserver-base.p12" \
        -name "${HostedDomain}" \
        -password "pass:atakatak"
fi

if [ ! -f "/ops/tak/certs/files/takserver-base.jks" ]; then
    cp "/etc/letsencrypt/live/${HostedDomain}/*" "/ops/tak/certs/${HostedDomain}/"

    keytool \
        -importkeystore \
        -srcstorepass "atakatak" \
        -deststorepass "atakatak" \
        -destkeystore "/ops/tak/certs/files/takserver-base.jks" \
        -srckeystore "/ops/tak/certs/${HostedDomain}/takserver-base.p12" \
        -srcstoretype "pkcs12"

    cp "/ops/tak/certs/${HostedDomain}/takserver-base.jks" "/ops/tak/certs/files/"
    /opt/tak/certs/makeCert.sh "server"
fi

node CoreConfig.js
mv ./CoreConfig.xml /opt/tak/CoreConfig.xml

/opt/tak/configureInDocker.sh init

